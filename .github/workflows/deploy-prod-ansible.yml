name: Deploy backend to ECS (prod) - via Ansible CD

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Branch to deploy"
        required: true
        default: "master"

permissions:
  contents: read
  id-token: write

env:
  AWS_REGION: ap-northeast-1
  ECR_REPO: ai-qa-chatbot-infra-prod
  FRONTEND_BUCKET: ai-qa-chatbot-infra-prod-frontend

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - name: Configure AWS credentials (assume role)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::472655909477:role/ai-qa-chatbot-ci-deploy-prod
          aws-region: ${{ env.AWS_REGION }}

      # -----------------------------
      # ECR build & push
      # -----------------------------
      - name: Login to Amazon ECR
        id: ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, tag, and push image
        env:
          REGISTRY: ${{ steps.ecr.outputs.registry }}
        run: |
          set -euo pipefail
          COMMIT_SHA="$(git rev-parse HEAD)"
          SHORT_SHA="${COMMIT_SHA::7}"

          IMAGE_URI_SHA="${REGISTRY}/${ECR_REPO}:gitsha-${SHORT_SHA}"
          IMAGE_URI_LATEST="${REGISTRY}/${ECR_REPO}:prod-latest"

          # 一次 build，打兩個 tag
          docker build -t "${IMAGE_URI_SHA}" -t "${IMAGE_URI_LATEST}" ./app/backend

          # 兩個都推
          docker push "${IMAGE_URI_SHA}"
          docker push "${IMAGE_URI_LATEST}"

          # Ansible 用不可變 tag（gitsha）
          echo "IMAGE_URI=${IMAGE_URI_SHA}" >> "$GITHUB_ENV"
          echo "[INFO] IMAGE_URI_SHA=${IMAGE_URI_SHA}"
          echo "[INFO] IMAGE_URI_LATEST=${IMAGE_URI_LATEST}"


      # -----------------------------
      # Pulumi (這段你原本完全缺)
      # -----------------------------
      - name: Install Pulumi CLI
        uses: pulumi/actions@v5

      - name: Pulumi login (non-interactive)
        shell: bash
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
        run: |
          set -euo pipefail
          pulumi login
          pulumi whoami || true

      # -----------------------------
      # Ansible
      # -----------------------------
      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible

      - name: Debug ansible effective vars
        shell: bash
        run: |
          set -euo pipefail
          ansible-inventory -i ansible/inventory/prod.yml --host localhost --yaml | sed -n '1,200p'

      - name: Deploy via Ansible (CD)
        shell: bash
        env:
          # ⚠️ 關鍵：Pulumi token 必須在 ansible 執行時也存在
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
        run: |
          set -euo pipefail
          cd ansible
          ansible-playbook \
            -i inventory/prod.yml \
            playbooks/ansible_cd_deploy.yml \
            -e "target_env=prod image_uri=${IMAGE_URI}" \
            -vv

      # -----------------------------
      # Frontend deploy (S3)
      # -----------------------------
      - name: Deploy frontend to S3 (prod)
        shell: bash
        run: |
          set -euo pipefail
          echo "[INFO] Sync frontend assets to s3://${FRONTEND_BUCKET}/"

          aws s3 sync frontend/ "s3://${FRONTEND_BUCKET}/" \
            --delete \
            --exclude "index.html" \
            --cache-control "public, max-age=31536000, immutable"

          aws s3 cp "frontend/index.html" "s3://${FRONTEND_BUCKET}/index.html" \
            --content-type "text/html" \
            --cache-control "no-cache, no-store, must-revalidate"


      - name: Smoke via Ansible (CD)
        shell: bash
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
        run: |
          set -euo pipefail
          cd ansible
          ansible-playbook \
            -i inventory/prod.yml \
            playbooks/ansible_cd_smoke.yml \
            -vv

