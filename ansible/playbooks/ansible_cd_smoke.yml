- name: "Ansible | CD | Smoke Test"
  hosts: dev
  gather_facts: false

  vars:
    headers_json:
      Content-Type: "application/json"

  tasks:
    - name: "ANSIBLE | Show base url"
      ansible.builtin.debug:
        msg:
          - "Base URL: {{ base_url }}"
          - "Frontend: {{ base_url }}{{ frontend_path }}"
          - "Health:   {{ base_url }}{{ health_path }}"
          - "Chat:     {{ base_url }}{{ chat_path }}"
          - "Timeout:  {{ timeout_seconds }}s"

    # -----------------------------
    # Frontend check (optional but nice)
    # -----------------------------
    - name: "ANSIBLE | Check frontend (GET /) (best-effort)"
      ansible.builtin.uri:
        url: "{{ base_url }}{{ frontend_path }}"
        method: GET
        return_content: false
        status_code: [200, 304]
        timeout: "{{ timeout_seconds }}"
      register: r_frontend
      retries: 5
      delay: 2
      until: r_frontend.status is defined and (r_frontend.status in [200, 304])
      failed_when: false

    - name: "ANSIBLE | Frontend check result"
      ansible.builtin.debug:
        msg:
          - "frontend_status={{ r_frontend.status | default('dns_fail_or_timeout') }}"
          - "frontend_url={{ base_url }}{{ frontend_path }}"


    # -----------------------------
    # Health check
    # -----------------------------
    - name: "ANSIBLE | Check health (GET /api/health)"
      ansible.builtin.uri:
        url: "{{ base_url }}{{ health_path }}"
        method: GET
        return_content: true
        status_code: 200
        timeout: "{{ timeout_seconds }}"
      register: r_health
      retries: 10
      delay: 3
      until: r_health.status is defined and r_health.status == 200


    - name: "ANSIBLE | Debug health response"
      ansible.builtin.debug:
        msg:
          - "status={{ r_health.status | default('') }}"
          - "body={{ r_health.content | default('') }}"

    # -----------------------------
    # Chat check - deterministic question
    # NOTE: your backend expects {question: "..."} now (not {message: "..."}).
    # -----------------------------
    - name: "ANSIBLE | Chat deterministic (POST /api/chat, 'What time is it?')"
      ansible.builtin.uri:
        url: "{{ base_url }}{{ chat_path }}"
        method: POST
        headers: "{{ headers_json }}"
        body_format: json
        body:
          question: "What time is it?"
        return_content: true
        status_code: 200
        timeout: "{{ timeout_seconds }}"
      register: r_chat_time

    - name: "ANSIBLE | Validate deterministic response has answer"
      ansible.builtin.assert:
        that:
          - r_chat_time.json is defined
          - (r_chat_time.json.answer is defined) or (r_chat_time.json.reply is defined)
          - ((r_chat_time.json.answer | default(r_chat_time.json.reply) | string | length) > 0)
          - ("[bedrock_error]" not in (r_chat_time.json.answer | default(r_chat_time.json.reply) | string))
        fail_msg: "Chat(time) invalid. Raw={{ r_chat_time.content | default('') }}"
        success_msg: "Chat(time) OK"

    - name: "ANSIBLE | Debug chat(time) response"
      ansible.builtin.debug:
        msg:
          - "status={{ r_chat_time.status | default('') }}"
          - "body={{ r_chat_time.content | default('') }}"

    # -----------------------------
    # Chat check - general question (Bedrock path)
    # -----------------------------
    - name: "ANSIBLE | Chat bedrock (POST /api/chat, general question)"
      ansible.builtin.uri:
        url: "{{ base_url }}{{ chat_path }}"
        method: POST
        headers: "{{ headers_json }}"
        body_format: json
        body:
          question: "Tell me a short joke."
        return_content: true
        status_code: 200
        timeout: "{{ timeout_seconds }}"
      register: r_chat_bedrock

    - name: "ANSIBLE | Validate bedrock response has answer"
      ansible.builtin.assert:
        that:
          - r_chat_bedrock.json is defined
          - (r_chat_bedrock.json.answer is defined) or (r_chat_bedrock.json.reply is defined)
          - ((r_chat_bedrock.json.answer | default(r_chat_bedrock.json.reply) | string | length) > 0)
          - ("[bedrock_error]" not in (r_chat_bedrock.json.answer | default(r_chat_bedrock.json.reply) | string))
        fail_msg: "Chat(bedrock) invalid. Raw={{ r_chat_bedrock.content | default('') }}"
        success_msg: "Chat(bedrock) OK"

    - name: "ANSIBLE | Debug chat(bedrock) response"
      ansible.builtin.debug:
        msg:
          - "status={{ r_chat_bedrock.status | default('') }}"
          - "body={{ r_chat_bedrock.content | default('') }}"
