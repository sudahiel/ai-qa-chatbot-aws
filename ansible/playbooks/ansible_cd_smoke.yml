- name: "Ansible | CD | Smoke Test"
  hosts: dev
  gather_facts: false

  vars:
    headers_json:
      Content-Type: "application/json"

    # ansible/playbooks -> repo root is ../..
    pulumi_workdir_abs: "{{ playbook_dir }}/../..//infra"

  pre_tasks:
    - name: "ANSIBLE | Read Pulumi output cloudfront_domain_name (optional)"
      ansible.builtin.command: pulumi stack output cloudfront_domain_name
      args:
        chdir: "{{ pulumi_workdir_abs }}"
      register: out_cf
      changed_when: false
      failed_when: false

    - name: "ANSIBLE | Read Pulumi output alb_dns_name (fallback)"
      ansible.builtin.command: pulumi stack output alb_dns_name
      args:
        chdir: "{{ pulumi_workdir_abs }}"
      register: out_alb
      changed_when: false

    - name: "ANSIBLE | Decide base_url (prefer CloudFront, else ALB)"
      ansible.builtin.set_fact:
        base_url: >-
          {{
            (
              (out_cf.stdout | default('') | trim)
              | ternary('https://' ~ (out_cf.stdout | trim), 'http://' ~ (out_alb.stdout | trim))
            )
          }}

    - name: "ANSIBLE | Show target"
      ansible.builtin.debug:
        msg:
          - "pulumi_workdir_abs={{ pulumi_workdir_abs }}"
          - "cloudfront_domain_name={{ out_cf.stdout | default('') | trim }}"
          - "alb_dns_name={{ out_alb.stdout | trim }}"
          - "Base URL: {{ base_url }}"
          - "Frontend: {{ base_url }}{{ frontend_path }}"
          - "Health:   {{ base_url }}{{ health_path }}"
          - "Chat:     {{ base_url }}{{ chat_path }}"
          - "Timeout:  {{ timeout_seconds }}s"

  tasks:
    # -----------------------------
    # Frontend check (best-effort)
    # -----------------------------
    - name: "ANSIBLE | Check frontend (GET /) (best-effort)"
      ansible.builtin.uri:
        url: "{{ base_url }}{{ frontend_path }}"
        method: GET
        return_content: false
        status_code: [200, 304]
        timeout: "{{ timeout_seconds }}"
      register: r_frontend
      retries: 5
      delay: 2
      until: r_frontend.status is defined and (r_frontend.status in [200, 304])
      failed_when: false

    - name: "ANSIBLE | Frontend check result"
      ansible.builtin.debug:
        msg:
          - "frontend_status={{ r_frontend.status | default('dns_fail_or_timeout') }}"
          - "frontend_url={{ base_url }}{{ frontend_path }}"

    # -----------------------------
    # Health check
    # -----------------------------
    - name: "ANSIBLE | Check health"
      ansible.builtin.uri:
        url: "{{ base_url }}{{ health_path }}"
        method: GET
        return_content: true
        status_code: 200
        timeout: "{{ timeout_seconds }}"
      register: r_health
      retries: 10
      delay: 3
      until: r_health.status is defined and r_health.status == 200

    - name: "ANSIBLE | Debug health response"
      ansible.builtin.debug:
        msg:
          - "status={{ r_health.status | default('') }}"
          - "body={{ r_health.content | default('') }}"

    # -----------------------------
    # Chat checks
    # -----------------------------
    - name: "ANSIBLE | Chat deterministic (What time is it?)"
      ansible.builtin.uri:
        url: "{{ base_url }}{{ chat_path }}"
        method: POST
        headers: "{{ headers_json }}"
        body_format: json
        body:
          question: "What time is it?"
        return_content: true
        status_code: 200
        timeout: "{{ timeout_seconds }}"
      register: r_chat_time

    - name: "ANSIBLE | Validate chat(time) response"
      ansible.builtin.assert:
        that:
          - r_chat_time.json is defined
          - (r_chat_time.json.answer is defined) or (r_chat_time.json.reply is defined)
          - ((r_chat_time.json.answer | default(r_chat_time.json.reply) | string | length) > 0)
        fail_msg: "Chat(time) invalid. Raw={{ r_chat_time.content | default('') }}"
        success_msg: "Chat(time) OK"

    - name: "ANSIBLE | Chat bedrock (Tell me a short joke.)"
      ansible.builtin.uri:
        url: "{{ base_url }}{{ chat_path }}"
        method: POST
        headers: "{{ headers_json }}"
        body_format: json
        body:
          question: "Tell me a short joke."
        return_content: true
        status_code: 200
        timeout: "{{ timeout_seconds }}"
      register: r_chat_bedrock

    - name: "ANSIBLE | Validate chat(bedrock) response"
      ansible.builtin.assert:
        that:
          - r_chat_bedrock.json is defined
          - (r_chat_bedrock.json.answer is defined) or (r_chat_bedrock.json.reply is defined)
          - ((r_chat_bedrock.json.answer | default(r_chat_bedrock.json.reply) | string | length) > 0)
        fail_msg: "Chat(bedrock) invalid. Raw={{ r_chat_bedrock.content | default('') }}"
        success_msg: "Chat(bedrock) OK"
